# .github/workflows/deploy.yml
name: Deploy API to Raspberry Pi

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  deploy_to_server:
    runs-on: ubuntu-20.04
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Server
        uses: easingthemes/ssh-deploy@v5.1.0
        with:
          REMOTE_HOST: ${{ secrets.PI_HOST }}
          REMOTE_USER: ${{ secrets.PI_USER }}
          SSH_PRIVATE_KEY: ${{ secrets.PI_SSH_KEY }}
          SCRIPT_BEFORE: |
            # Check if .env exists, exit if not
            if [ ! -f $HOME/api/french-citizenship-api/.env ]; then
              echo "ERROR: .env file not found at $HOME/api/french-citizenship-api/.env"
              echo "Please create the .env file first before deploying"
              exit 1
            fi
            # Create directories
            mkdir -p $HOME/api/french-citizenship-api/data
            mkdir -p $HOME/api/french-citizenship-api/logs
          SOURCE: '.'
          TARGET: '$HOME/api/french-citizenship-api'
          SCRIPT_AFTER: |
            cd $HOME/api/french-citizenship-api
            
            # Deploy with Docker Compose
            docker-compose down || true
            docker rmi french-citizenship-api_api || true
            docker-compose up -d --build
            
            # Show status
            echo '=== Container Status ==='
            docker-compose ps
            
            echo '=== API Logs ==='
            docker-compose logs --tail=20 api
            
            # Health check
            echo "Waiting for API to start..."
            sleep 20
            
            if ! docker-compose ps | grep -q 'Up'; then
              echo 'ERROR: API container is not running'
              docker-compose ps
              docker-compose logs api
              exit 1
            fi
            
            if curl -f http://localhost:8043/health > /dev/null 2>&1; then
              echo 'API health check: PASSED'
              echo 'API deployment successful!'
            else
              echo 'API health check: FAILED'
              docker-compose logs api
              exit 1
            fi